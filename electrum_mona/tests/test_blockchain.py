from electrum_mona import constants, blockchain
from electrum_mona.blockchain import Blockchain

from . import SequentialTestCase


class testBlockchain(SequentialTestCase):

    def test_get_target(self):

        # before DGWv3 with checkpoint(height=2015)
        headers1 = {2015: {'version': 2, 'prev_block_hash': 'f9cba205f996e98f61f87e32ae57fc0a5befa6cd632dd257f3e239f390010622', 'merkle_root': 'af68c1f62b965172df1d81fba95f193cb8e42431bad79a4bfbcc370d301d5710', 'timestamp': 1388536705, 'bits': 503936911, 'nonce': 780010496, 'block_height': 2015}}
        bits = Blockchain.get_target(self, 2015, headers1)
        self.assertEqual(bits, 65339010432214603900175979833807329994044402934458085644623414103638016)

        # before DGWv3 without checkpoint(height=2016)
        headers2 = {2015: {'version': 2, 'prev_block_hash': 'f9cba205f996e98f61f87e32ae57fc0a5befa6cd632dd257f3e239f390010622', 'merkle_root': 'af68c1f62b965172df1d81fba95f193cb8e42431bad79a4bfbcc370d301d5710', 'timestamp': 1388536705, 'bits': 503936911, 'nonce': 780010496, 'block_height': 2015}}
        bits = Blockchain.get_target(self, 2016, headers2)
        self.assertEqual(bits, 0)

        # after DGWv3 with checkpoint(height=461663)
        headers3 = {461663: {'version': 3, 'prev_block_hash': '9c87f1e27717aec18617496970b9744dd855f997128fab6733e709fd95d97870', 'merkle_root': '7f22e9001ab92b14a1b057ce07c4f2acecb693f3a645004f36c2246b7ea86c3b', 'timestamp': 1444439492, 'bits': 469801026, 'nonce': 928239, 'block_height': 461663}}
        bits = Blockchain.get_target(self, 461663, headers3)
        self.assertEqual(bits, 62635231089126922960074598435273835921110428291665699134377033728)

        # after DGWv3 without checkpoint(height=461664)
        headers4 = {461663: {'version': 3, 'prev_block_hash': '9c87f1e27717aec18617496970b9744dd855f997128fab6733e709fd95d97870', 'merkle_root': '7f22e9001ab92b14a1b057ce07c4f2acecb693f3a645004f36c2246b7ea86c3b', 'timestamp': 1444439492, 'bits': 469801026, 'nonce': 928239, 'block_height': 461663}}
        bits = Blockchain.get_target(self, 461664, headers4)
        self.assertEqual(bits, 0)

        # after DGWv3 after checkpoint(1707551)
        headers5 = {1707526: {'version': 536870912, 'prev_block_hash': '874988dd78dfa5d381c0f7b2526e14667d00a7b3303ab5f45f35281125b49801', 'merkle_root': '7c80d7ee73fc98a1998a235e5b4f36c26768b640e3a20ba3035077ecb8879c0b', 'timestamp': 1562246139, 'bits': 437895282, 'nonce': 2430381347, 'block_height': 1707526}, 1707527: {'version': 536870912, 'prev_block_hash': '558c1cd19f8cc8f3a1d479a58181e252df836ca6c649d83e891bf4817b1b1098', 'merkle_root': 'ca1abed07e020e9b85cd191d64bdcef31d69da94eb0e8c9fad99945bea0b8d42', 'timestamp': 1562246294, 'bits': 437889086, 'nonce': 101056101, 'block_height': 1707527}, 1707528: {'version': 536870912, 'prev_block_hash': '6ee0ea740274b9f5fb3b6c4569db70889f209e82f0169dcaf2df9554182689fa', 'merkle_root': '8569992f6a3b40897d1bb9c2e35d9694fecbee2627961ff31712dcf5624cb166', 'timestamp': 1562246427, 'bits': 437952953, 'nonce': 1653806761, 'block_height': 1707528}, 1707529: {'version': 536870912, 'prev_block_hash': '7fe27aa5489898a30e2f5874c93f24b33374b41b4ccacd077f9da19de556813d', 'merkle_root': '57c16fd592f2225e206c65065c4aab5cde5ace2217f78bbe266f4640d1a06afd', 'timestamp': 1562246456, 'bits': 437940884, 'nonce': 3162070736, 'block_height': 1707529}, 1707530: {'version': 536870912, 'prev_block_hash': '6c0ff7aabf69e34a2cea82213fe3d42dfe2d00efe6c9b166269a3365b0130332', 'merkle_root': '37d2deb9ff9e6a2ef9eee3ba3636aabfff776e7e8aa021e7591b2aba6c71d25a', 'timestamp': 1562246481, 'bits': 437969555, 'nonce': 3977075999, 'block_height': 1707530}, 1707531: {'version': 536870912, 'prev_block_hash': '31a1a590cb5d07af89ba9e23989086843d22f2315f44c62f17cf7a26b2aae170', 'merkle_root': '06532b55edd890d72e68afb50eb8c1346d4c7029365f045af4e0b3fbb70b9290', 'timestamp': 1562246600, 'bits': 437815774, 'nonce': 3514029424, 'block_height': 1707531}, 1707532: {'version': 536870912, 'prev_block_hash': 'a5f85759369694e44c94fbb8648f911aa5346676ae35ea5d93d82faa4460fbd0', 'merkle_root': '711dc51a2e0ce4fc5df7e3db8b4418db2c12fac5e71cd5008c78b9997dfb8126', 'timestamp': 1562247070, 'bits': 437802640, 'nonce': 2556934565, 'block_height': 1707532}, 1707533: {'version': 536870912, 'prev_block_hash': '7ac87867ff6ce468ddcaedd6a9770c8743a79aabf43454c42a5053be5b85a153', 'merkle_root': 'e56b7f47f67b8a20eed524fb4cd6ed8bc7155276663dd5157a0d6617e741c3fb', 'timestamp': 1562247143, 'bits': 438063026, 'nonce': 1039027030, 'block_height': 1707533}, 1707534: {'version': 536870912, 'prev_block_hash': 'd0e5a365fc7b9df5699b60e77ca06fb5c1f22a27b23148a2544b8f7b924eadfa', 'merkle_root': '3137d9a9b68e8c3650e98c1a4dd8305cc4cdf2b57c7bc0e3805729c892af0d78', 'timestamp': 1562247305, 'bits': 438146738, 'nonce': 461450592, 'block_height': 1707534}, 1707535: {'version': 536870912, 'prev_block_hash': '98493346fe35ae204c91ed9000a6955af18d88b8b850b26fa8e250e28ff9cc4a', 'merkle_root': '94761dc3a52d52f975adf59c4ed8eb8f85a3069bab31456f01c1923fc389376e', 'timestamp': 1562247314, 'bits': 438167424, 'nonce': 3453964371, 'block_height': 1707535}, 1707536: {'version': 536870912, 'prev_block_hash': '36a0c28a51ba3c74a63e08616e2d6b6d152a0bb0628eedd77d109ab3c5edc72a', 'merkle_root': '0032ef748b51fcebc0ad8ab0c68d3fef4f939e6667b52c1cc95a695a582e49d0', 'timestamp': 1562247343, 'bits': 438114457, 'nonce': 2446001056, 'block_height': 1707536}, 1707537: {'version': 536870912, 'prev_block_hash': 'add6b3ca3955c8364750f50a60a06cb3e84e26c1b2b7deb0fc7aa9e09546aa0a', 'merkle_root': 'b6e56318ccb2e603a4705229a3d23ecca02bfc24b4fe93f5585b0809d1f1b2c6', 'timestamp': 1562247344, 'bits': 438138462, 'nonce': 3738124454, 'block_height': 1707537}, 1707538: {'version': 536870912, 'prev_block_hash': 'db812b27cb4fe49e03b99ff101769ad57aeb83ab040b4d04592c9156c96e0495', 'merkle_root': '08135416fe9d57ba31d5539748ba806f5eeb1cb4e12b9b01093976b177a9adb7', 'timestamp': 1562247359, 'bits': 438118419, 'nonce': 646699137, 'block_height': 1707538}, 1707539: {'version': 536870912, 'prev_block_hash': 'e101ecf02a2e01065af7070d10f85fb01faee308ff35555f44e3e5190e49f152', 'merkle_root': '495356493a66f49eab65a04f023f1685188145d45685db5f7433970e98a55773', 'timestamp': 1562247389, 'bits': 438052729, 'nonce': 3554523013, 'block_height': 1707539}, 1707540: {'version': 536870912, 'prev_block_hash': 'eed717a98b4de59eda74ae0a905828ce8b65a00f5f6c6ef222a6220f677a1c73', 'merkle_root': 'fdd373eb5cee3286dae213209d02be7f67fea23524faf67266587450f28c8f39', 'timestamp': 1562247616, 'bits': 438070773, 'nonce': 1304815362, 'block_height': 1707540}, 1707541: {'version': 536870912, 'prev_block_hash': '4b491163cd6df7f466749733eb233b1358b152651adc2167ee2f6846a840d269', 'merkle_root': '65037c41cfcaa0d100dea0503044080f8ea93b20d1ff5514f4cd15a4aae572ec', 'timestamp': 1562247633, 'bits': 438195390, 'nonce': 3201765268, 'block_height': 1707541}, 1707542: {'version': 536870912, 'prev_block_hash': 'd005a9f7be70dd7fa2f82df8b38cdc4b8b8874a665eeded86ff20940328dc014', 'merkle_root': '31a26bee7d707ce14052de0e05eb2df26553a6bb17d0fecbb22abcdbd9c66469', 'timestamp': 1562247665, 'bits': 438220107, 'nonce': 2833746892, 'block_height': 1707542}, 1707543: {'version': 536870912, 'prev_block_hash': '80710fa9866d87b3dfb2788c9b14ec548c1f97b37fcab4bf2631733b94cbe630', 'merkle_root': '4e7aad79ffc3c1ae55e06280bb16692a4c4009347523d0c65905fc91a9e847cb', 'timestamp': 1562247684, 'bits': 438118960, 'nonce': 2972780689, 'block_height': 1707543}, 1707544: {'version': 536870912, 'prev_block_hash': '599f5780442bc81b6f226d1145820e3b4183203fe04439fc9b62a1a3765e9f5b', 'merkle_root': '88a47ae505124323dc2f714b1fc01b51045d4ad3f07cbeba78f57cc528c9ff03', 'timestamp': 1562247727, 'bits': 438025974, 'nonce': 102288161, 'block_height': 1707544}, 1707545: {'version': 536870912, 'prev_block_hash': '9e4b48313b2ff231b0632328b55531503af91abd30d713969eb1524043c9be46', 'merkle_root': '7d642ec7b255bea77da5a05c8737cd8d8dabf37d6e3f89d64eb3b1ea43c73973', 'timestamp': 1562247740, 'bits': 437787465, 'nonce': 1803675336, 'block_height': 1707545}, 1707546: {'version': 536870912, 'prev_block_hash': '4a6644f1407ab762c6ec91613656a997fc3db811d676c1d222d04e35c57dd0d3', 'merkle_root': '1456c47ba506c046aa16aef0aa67f0d8ceeb6a041972cc2b28d83bbe707e3903', 'timestamp': 1562247771, 'bits': 437701755, 'nonce': 3311352330, 'block_height': 1707546}, 1707547: {'version': 536870912, 'prev_block_hash': 'b44d9dd71d63f396c31e1b151a5b419300202b2e71842dc3bf8b269ff904af55', 'merkle_root': '600a41bf236581dd40c56b4936efe5f73811b94773f5476ab6da2a9b91d0fe00', 'timestamp': 1562247853, 'bits': 437619636, 'nonce': 3784494570, 'block_height': 1707547}, 1707548: {'version': 536870912, 'prev_block_hash': '635f4dba3cc4490fc1bd7f4333a250206718499f97c02a50c3930bd01632c0e1', 'merkle_root': '3287b494aaab1e9afbb0a24cad4c383c9b81f0bca621d297592dea213c4dfd9a', 'timestamp': 1562247994, 'bits': 437642314, 'nonce': 3619832366, 'block_height': 1707548}, 1707549: {'version': 536870912, 'prev_block_hash': '60bf9102bbfab4f5e1ae40eb94bf70f138c944b31de88e9e0e6ce8143df9c5e8', 'merkle_root': 'c3bf85b4954d9a989d3472bb8e9f113c938a144df61a472470095ab0cb6c2c53', 'timestamp': 1562248611, 'bits': 437716658, 'nonce': 390947937, 'block_height': 1707549}, 1707550: {'version': 536870912, 'prev_block_hash': '5765eb1e773a9b525f30b89630cf57d33cff4916d8cdefb5f0e9f3160d17ea12', 'merkle_root': '5e31b1b79257284f552f5f8c75e9e251c6976d6ade1413917c4feb3de410eeb5', 'timestamp': 1562248616, 'bits': 438207771, 'nonce': 3830142667, 'block_height': 1707550}, 1707551: {'version': 536870912, 'prev_block_hash': 'be95c3e12809605962148a4f12febf91f72ba7cca217571c8a62a943adca00ab', 'merkle_root': '681fb4658fa58cb8e58c1b0c99bedd347f60d1e7867086c78c63162ac159be0f', 'timestamp': 1562248631, 'bits': 438120957, 'nonce': 1114471605, 'block_height': 1707551}}
        bits = Blockchain.get_target(self, 1707551, headers5)
        self.assertEqual(bits, 46915004499996799511183541136439400406280582026006570951401007)


