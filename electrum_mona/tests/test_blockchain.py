from electrum_mona import constants, blockchain
from electrum_mona.blockchain import Blockchain

from . import SequentialTestCase


class testBlockchain(SequentialTestCase):

    def test_get_target(self):

        # before DGWv3 with checkpoint(height=2015)
        headers1 = {2015: {'version': 2, 'prev_block_hash': 'f9cba205f996e98f61f87e32ae57fc0a5befa6cd632dd257f3e239f390010622', 'merkle_root': 'af68c1f62b965172df1d81fba95f193cb8e42431bad79a4bfbcc370d301d5710', 'timestamp': 1388536705, 'bits': 503936911, 'nonce': 780010496, 'block_height': 2015}}
        bits = Blockchain.get_target(self, 2015, headers1)
        self.assertEqual(bits, 65339010432214603900175979833807329994044402934458085644623414103638016)

        # before DGWv3 without checkpoint(height=2016)
        headers2 = {2015: {'version': 2, 'prev_block_hash': 'f9cba205f996e98f61f87e32ae57fc0a5befa6cd632dd257f3e239f390010622', 'merkle_root': 'af68c1f62b965172df1d81fba95f193cb8e42431bad79a4bfbcc370d301d5710', 'timestamp': 1388536705, 'bits': 503936911, 'nonce': 780010496, 'block_height': 2015}}
        bits = Blockchain.get_target(self, 2016, headers2)
        self.assertEqual(bits, 0)

        # after DGWv3 with checkpoint(height=461663)
        headers3 = {461663: {'version': 3, 'prev_block_hash': '9c87f1e27717aec18617496970b9744dd855f997128fab6733e709fd95d97870', 'merkle_root': '7f22e9001ab92b14a1b057ce07c4f2acecb693f3a645004f36c2246b7ea86c3b', 'timestamp': 1444439492, 'bits': 469801026, 'nonce': 928239, 'block_height': 461663}}
        bits = Blockchain.get_target(self, 461663, headers3)
        self.assertEqual(bits, 62635231089126922960074598435273835921110428291665699134377033728)

        # after DGWv3 without checkpoint(height=461664)
        headers4 = {461663: {'version': 3, 'prev_block_hash': '9c87f1e27717aec18617496970b9744dd855f997128fab6733e709fd95d97870', 'merkle_root': '7f22e9001ab92b14a1b057ce07c4f2acecb693f3a645004f36c2246b7ea86c3b', 'timestamp': 1444439492, 'bits': 469801026, 'nonce': 928239, 'block_height': 461663}}
        bits = Blockchain.get_target(self, 461664, headers4)
        self.assertEqual(bits, 0)

        # after DGWv3 after checkpoint(1707577)
        headers5 = {1707552: {'version': 536870912, 'prev_block_hash': 'cbf4f8472308b332a146e224a029c8da8c247a5969d55120aeaebe09ddd3349d', 'merkle_root': 'e7072b993a857eac248968226de0442f653849b4e9e60389b1ff2f33a0198a6e', 'timestamp': 1562248741, 'bits': 438029645, 'nonce': 2789703934, 'block_height': 1707552}, 1707553: {'version': 536870912, 'prev_block_hash': '48ff72a7d036694e9ed274d213f9a2426a50467071df3feda04ab04ad8680cfe', 'merkle_root': '7a7ee20c7692dc24747543d03997c0bec5366dcdb9a94336144a236787ed2c04', 'timestamp': 1562248829, 'bits': 438095989, 'nonce': 3164952393, 'block_height': 1707553}, 1707554: {'version': 536870912, 'prev_block_hash': '5a96121d84a93d7552096aaac67915301cb436bb9ce573039095d5dd493b653e', 'merkle_root': '991e5bd597b65897c7f45d26416b61f8b14af8232c7a100fb114a8d0e89abbc9', 'timestamp': 1562248935, 'bits': 438157682, 'nonce': 1445694404, 'block_height': 1707554}, 1707555: {'version': 536870912, 'prev_block_hash': '422a5fe3981f83287c5a9b0dccf19cc70c4e67b01e36bb1477d651f94fc48f8b', 'merkle_root': 'a2f7addc721296d3ca3fa1818f919ef9764e9ca373e5c8433de84437eb6165de', 'timestamp': 1562248961, 'bits': 438157688, 'nonce': 1478829295, 'block_height': 1707555}, 1707556: {'version': 536870912, 'prev_block_hash': '584466ff1759343d10b78d0ab01e3629069ea7d10b89564b081e8d9ff5ff3c30', 'merkle_root': 'e321947646ac624c69f016d7230113770433ee428d42723d768eb7fa14d87e36', 'timestamp': 1562249235, 'bits': 437798855, 'nonce': 3758975225, 'block_height': 1707556}, 1707557: {'version': 536870912, 'prev_block_hash': '50b5ca95fcac67407dcde71ede2db3ef53b1d1344156a692db44c413d7312a4a', 'merkle_root': '1c145e28cd1a97ba5a3e49358ead6f11a9583f9cccc3a5da11213d9a6928e58c', 'timestamp': 1562249522, 'bits': 437953945, 'nonce': 1836890567, 'block_height': 1707557}, 1707558: {'version': 536870912, 'prev_block_hash': '1fca0a8366b93b1c008d63a331056cacb6cf7422620dbd4f2152db0231194015', 'merkle_root': '3888f38e1f8d355a23681510042a6b9c9da0f800bd1fe5d00d110360343b2992', 'timestamp': 1562249540, 'bits': 438060179, 'nonce': 4102151957, 'block_height': 1707558}, 1707559: {'version': 536870912, 'prev_block_hash': '8694453c547aac5d3cb3303a1ce113a80d05034ef441de49ebe0e5a50f1d089a', 'merkle_root': 'ddf7dfc4978dca3a9e81130348d8e488eeca1b8d400b025fc977df89e308b50a', 'timestamp': 1562249572, 'bits': 438068511, 'nonce': 4081611534, 'block_height': 1707559}, 1707560: {'version': 536870912, 'prev_block_hash': '010de19d9cf0f70e9c6bf8d81274d7bf083ee0f47e0dcc9a9339a3273cb0d8ff', 'merkle_root': '5eae451db7fa02b440d73505de56152f31f5b7691a385a1f9d43cc188196d72a', 'timestamp': 1562249587, 'bits': 438067280, 'nonce': 2683725381, 'block_height': 1707560}, 1707561: {'version': 536870912, 'prev_block_hash': 'c32967fb0ce200bcc7ad8c6776d1db76b89ac6b2638b2b93c0eb7147c93eabb1', 'merkle_root': 'b4fb627299b2898be36c20e7e1952e62c25c9a9ae91502b9f0c31f58dd5ef148', 'timestamp': 1562249642, 'bits': 438076949, 'nonce': 1851081340, 'block_height': 1707561}, 1707562: {'version': 536870912, 'prev_block_hash': '2b27d0a5a8907e8b4238e99bcc4c6181d41dd5991e34a48434ef3c41f7c74303', 'merkle_root': 'afc6babf8f3a9a4407efd8b35735d134afce2c1a05bc40e2f0cd7bbc0f2f9232', 'timestamp': 1562249744, 'bits': 438108094, 'nonce': 336655862, 'block_height': 1707562}, 1707563: {'version': 536870912, 'prev_block_hash': 'fcbddae87247934e8c5a37199e462aea5074649e64e52f510b006809b1ed4fba', 'merkle_root': 'e494390d0ec0c7667285561cb9a6f5fe33e962de95794c970ef2420a775d3002', 'timestamp': 1562249861, 'bits': 438168938, 'nonce': 821061911, 'block_height': 1707563}, 1707564: {'version': 536870912, 'prev_block_hash': 'a0a3313e2e27e6131b05fcbba565a346dda505272b24fc0d2af7cb01137c8bbc', 'merkle_root': '8497a0c7158c85fa2020a2d53d70f89f3feddc5b2fcc2e61b5cf6624940b1c2e', 'timestamp': 1562249982, 'bits': 438084687, 'nonce': 2147099528, 'block_height': 1707564}, 1707565: {'version': 536870912, 'prev_block_hash': '4b8425fdbb06945173be0cf489ee0b93c01f63cf0031bf5c8b80d54b85b650d4', 'merkle_root': '0ff67721536e3cda4927cfbfcc9479e33d5ea37d59b2ceb6238ca28730e5ac92', 'timestamp': 1562250002, 'bits': 438168583, 'nonce': 3843225892, 'block_height': 1707565}, 1707566: {'version': 536870912, 'prev_block_hash': '2397a2a53e95377393838f0fcc5e56058f67091f0f29f9052abd11cb08f8482d', 'merkle_root': '99d2149c54966f66204218e537da0ca37870405007d2beb76db4c65db2c506db', 'timestamp': 1562250012, 'bits': 438161036, 'nonce': 1959715855, 'block_height': 1707566}, 1707567: {'version': 536870912, 'prev_block_hash': 'bd9785c0b5064156b5b679f432d7094ba549669eb0621589114f073318b9f079', 'merkle_root': '841a902029ec01695a977a90fe18805fe595cc5b4fd99eb98d44113e7b615d2e', 'timestamp': 1562250094, 'bits': 438150641, 'nonce': 2029322498, 'block_height': 1707567}, 1707568: {'version': 536870912, 'prev_block_hash': '971559f276f5035ba270ddcc43a4577d01512b9e8f15c03ac4adb2ce2410cd3f', 'merkle_root': 'b2c37f344fe96d0f6e6a6fa3a76ae16a9a20d05b95dfde43f54da267f377086f', 'timestamp': 1562250273, 'bits': 438184125, 'nonce': 1309432981, 'block_height': 1707568}, 1707569: {'version': 536870912, 'prev_block_hash': '1a41cc2e2e3fff671ac76b4f3917bdad1173e9e95615b1157c058cf88c7901d8', 'merkle_root': '012a385ae807323c9b84841066572c5e12b7f449e354ba57c08e2a053d0da91e', 'timestamp': 1562250323, 'bits': 438331729, 'nonce': 2182159598, 'block_height': 1707569}, 1707570: {'version': 536870912, 'prev_block_hash': 'ea486c2cf14cfa12bbede9796e3f908840d95bbd76e2c22e9c39c7e8d0541c63', 'merkle_root': 'dfca511e854e1772183803186d65fa89635d61ee8eda778e9d6e9ee2d75d8db6', 'timestamp': 1562250360, 'bits': 438380359, 'nonce': 1378459661, 'block_height': 1707570}, 1707571: {'version': 536870912, 'prev_block_hash': '311f1543cde1d4d94e397369bb857839a68da7b5da220232a9e3e2778ff80fb6', 'merkle_root': '8043d19f3312e455413ed9926ff3c4b1e80322be5bb7cbfd7769ebb31910595d', 'timestamp': 1562250374, 'bits': 438375809, 'nonce': 1935902239, 'block_height': 1707571}, 1707572: {'version': 536870912, 'prev_block_hash': 'bd1a7c8d557195ccb51da479c8742fd45eed6343f19035dd88128b4c1fe837e9', 'merkle_root': 'c7128f5abfa5859b9045e86f2733e954e7e36e476e93a2e74f9cb4663c6e9179', 'timestamp': 1562250396, 'bits': 438299099, 'nonce': 141005783, 'block_height': 1707572}, 1707573: {'version': 536870912, 'prev_block_hash': '6c2628421ad9f65a3f5f534b9272003a68ae041909da7836561a6a405b92f16d', 'merkle_root': '528e348a05b0ad3847d3de2daef21925f74db3d537b118fa692e2e49c2f57c77', 'timestamp': 1562250490, 'bits': 437795403, 'nonce': 2301343266, 'block_height': 1707573}, 1707574: {'version': 536870912, 'prev_block_hash': '2fbf78a9bd6fecc27fab132c885da037355ffba8c29ae6fb666ecde4f8d2faa2', 'merkle_root': '415f0822a45f274c46bafc0a1a1536bdeb8b1c098ccf8055cc1e270dd28d35af', 'timestamp': 1562250959, 'bits': 437859823, 'nonce': 3905424503, 'block_height': 1707574}, 1707575: {'version': 536870912, 'prev_block_hash': '41e124c937a0923b80930f22580fb5b10c671588426bb9560798fa171747f75f', 'merkle_root': '1ef7fb4536283b8ec1f96c0de96933506e6727f31eda3fa4cc6672507d395cf4', 'timestamp': 1562251121, 'bits': 438247867, 'nonce': 980139439, 'block_height': 1707575}, 1707576: {'version': 536870912, 'prev_block_hash': '80bc982acc2fd07fda9eab66ff3bc4dda53832070cdfa4b39bab2f3323526d77', 'merkle_root': '1f92db8180b4902260f10f2b60bdd558036478fe7955af3ae60ec98ee74efb39', 'timestamp': 1562251156, 'bits': 438316136, 'nonce': 1154901627, 'block_height': 1707576}, 1707577: {'version': 536870912, 'prev_block_hash': '62aed78a2bba10217a30bd4343b6b1f0f7814d60c53011a2077bd8224d6c32e5', 'merkle_root': '06a42184dcb2378dd07eee92a9d27efb577bc690845cc483549a679edce3f7f2', 'timestamp': 1562251530, 'bits': 438284469, 'nonce': 2933328142, 'block_height': 1707577}}
        bits = Blockchain.get_target(self, 1707577, headers5)
        self.assertEqual(bits, 50924303622638816608903496611932117387916353275391498616157721)

